#!/usr/bin/bash
# Loguard - Real-time Linux Login Alert to Telegram
# Version: 1.2.0
# GitHub: https://github.com/Nowafen/loguard

set -euo pipefail

VERSION="1.0.0"
INSTALL_DIR="/opt/loguard"
CONFIG_DIR="/etc/loguard"
CONFIG_FILE="$CONFIG_DIR/config.toml"
QUEUE_FILE="/var/log/loguard/pending_alerts.jsonl"
LOG_FILE="/var/log/loguard/alert.log"
PAM_FILES="/etc/pam.d/common-session /etc/pam.d/common-session-noninteractive /etc/pam.d/sshd /etc/pam.d/login /etc/pam.d/su /etc/pam.d/sudo"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; CYAN='\033[0;36m'; NC='\033[0m'

log() { echo -e "${BLUE}[Loguard]$NC $*"; }
success() { echo -e "${GREEN}Success$NC $*"; }
warn() { echo -e "${YELLOW}Warning$NC $*"; }
error() { echo -e "${RED}Error$NC $*"; }

check_root() {
    [[ $EUID -eq 0 ]] || { error "This command must be run as root (use sudo)"; exit 1; }
}

load_config() {
    [[ -f "$CONFIG_FILE" ]] || return 1
    source <(grep -E '^(bot_token|chat_id|hostname) *=' "$CONFIG_FILE" | sed 's/ *= */=/g' 2>/dev/null || true)
    BOT_TOKEN="${bot_token:-}"
    CHAT_ID="${chat_id:-}"
    HOSTNAME="${hostname:-}"
    return 0
}

save_config() {
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_FILE" <<EOF
# Loguard Configuration - Edited via wizard
bot_token = "$1"
chat_id   = "$2"
hostname  = "$3"
EOF
    success "Configuration saved to $CONFIG_FILE"
}

mask_token() {
    local token="$1"
    [[ -z "$token" ]] && echo "(not set)" && return
    local len=${#token}
    [[ $len -le 20 ]] && echo "$token" && return
    echo "${token:0:10}...${token: -8}"
}

edit_config_wizard() {
    clear
    echo -e "${CYAN}Loguard Configuration Wizard${NC}"
    echo -e "Config file: ${YELLOW}$CONFIG_FILE${NC}"
    echo

    load_config
    local current_token="$BOT_TOKEN"
    local current_chat="$CHAT_ID"
    local current_host="${HOSTNAME:-$(hostname)}"

    while true; do
        echo -e "${BLUE}Current Settings:${NC}"
        echo "1. Bot Token      → $(mask_token "$current_token")"
        echo "2. Chat ID        → ${current_chat:-"(not set)"}"
        echo "3. Hostname       → ${current_host:-"(auto: $(hostname)"}"
        echo
        echo -e "4. ${GREEN}Save & Exit${NC}"
        echo -e "5. ${RED}Exit without saving${NC}"
        echo
        read -p "Enter choice [1-5]: " choice
        echo

        case "$choice" in
            1)
                read -p "Enter Bot Token (or press Enter to keep current): " new_token
                [[ -n "$new_token" ]] && current_token="$new_token"
                success "Bot Token updated"
                ;;
            2)
                read -p "Enter Chat ID (or press Enter to keep current): " new_chat
                [[ -n "$new_chat" ]] && current_chat="$new_chat"
                success "Chat ID updated"
                ;;
            3)
                read -p "Enter custom hostname (or leave empty for auto): " new_host
                current_host="${new_host:-}"
                [[ -z "$current_host" ]] && echo "Hostname will use system default" || success "Hostname set to: $current_host"
                ;;
            4)
                echo -e "${YELLOW}Final Configuration:${NC}"
                echo "Bot Token : $(mask_token "$current_token")"
                echo "Chat ID   : ${current_chat:-"(empty!)"}"
                echo "Hostname  : ${current_host:-"(auto)"}"
                echo
                [[ -z "$current_token" || -z "$current_chat" ]] && {
                    warn "Bot Token and Chat ID are required!"
                    read -p "Continue anyway? [y/N]: " force
                    [[ ! "$force" =~ ^[Yy]$ ]] && continue
                }
                read -p "Apply changes? [Y/n]: " confirm
                [[ "$confirm" =~ ^[Nn]$ ]] && { warn "Changes discarded"; return; }
                save_config "$current_token" "$current_chat" "$current_host"
                echo
                success "Configuration applied successfully!"
                echo -e "${GREEN}Tip: Run 'sudo loguard test' to verify connection${NC}"
                return
                ;;
            5)
                warn "No changes saved"
                return
                ;;
            *) warn "Invalid option" ;;
        esac
        echo; read -p "Press Enter to continue..."
        clear
    done
}

# --- بقیه توابع بدون تغییر ---
is_enabled() { grep -q "^session.*pam_exec.so.*login-alert.sh" $PAM_FILES 2>/dev/null || return 1; return 0; }
count_pending() { [[ -f "$QUEUE_FILE" ]] && wc -l < "$QUEUE_FILE" 2>/dev/null || echo 0; }
last_alert() { tail -1 "$LOG_FILE" 2>/dev/null | awk '{print $1" "$2" → "$4"@"$5" from "$7}' || echo "Never"; }

telegram_test() {
    load_config || { error "Config not found or invalid"; return 1; }
    [[ -n "$BOT_TOKEN" && -n "$CHAT_ID" ]] || { error "bot_token or chat_id missing in config"; return 1; }
    local msg="*Loguard Test*%0AHost: <code>$(hostname)</code>%0ATime: <code>$(date '+%Y-%m-%d %H:%M:%S')</code>"
    if curl -s -m 10 --data "chat_id=$CHAT_ID" --data "text=$msg" --data "parse_mode=HTML" \
       "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" > /dev/null; then
        success "Test message sent! Check your Telegram."
    else
        error "Failed to send. Check token/chat_id/internet."
    fi
}

show_status() {
    echo -e "${BLUE}Loguard Login Alert System${NC}"
    is_enabled && echo -e "Status:      ${GREEN}Enabled${NC}" || echo -e "Status:      ${RED}Disabled${NC}"
    load_config && [[ -n "$BOT_TOKEN" && -n "$CHAT_ID" ]] && echo -e "Telegram:    ${GREEN}Configured${NC}" || echo -e "Telegram:    ${RED}Not configured${NC}"
    echo -e "Queue:       $(count_pending) pending"
    echo -e "Last Alert:  $(last_alert)"
    echo -e "Version:     $VERSION"
}

enable_alerts() {
    local pam_line="session optional pam_exec.so stdout $INSTALL_DIR/login-alert.sh"
    local added=0

    for file in common-session common-session-noninteractive sshd login su sudo; do
        local target="/etc/pam.d/$file"
        [[ -f "$target" ]] || continue

        # Remove any existing Loguard lines (clean state)
        sed -i '/loguard\|login-alert\.sh/d' "$target" 2>/dev/null || true

        # Add our lines
        echo "# Loguard - Real-time login alerts" >> "$target"
        echo "$pam_line" >> "$target"
        ((added++))
    done

    [[ $added -gt 0 ]] && success "Loguard enabled on $added PAM configurations" || warn "No PAM files were modified"
}

disable_alerts() {
    local removed=0
    for file in common-session common-session-noninteractive sshd login su sudo; do
        local target="/etc/pam.d/$file"
        [[ -f "$target" ]] || continue
        if sed -i '/loguard\|login-alert\.sh/d' "$target" 2>/dev/null; then
            ((removed++))
        fi
    done
    [[ $removed -gt 0 ]] && success "Loguard disabled (removed from $removed files)" || warn "Loguard was not active"
}

show_logs() { tail -n "${1:-20}" "$LOG_FILE" 2>/dev/null | tac | awk '{printf "%s %s | %-8s | %-15s | %s\n", $1,$2,$4,$7,$9}' || echo "No logs"; }
show_queue() { echo "Pending: $(count_pending)"; [[ $(count_pending) -gt 0 ]] && head -5 "$QUEUE_FILE" | jq -r '.msg' | nl; }
clear_queue() { read -p "Clear queue? [y/N]: " a; [[ "$a" =~ ^[Yy]$ ]] && : > "$QUEUE_FILE" && success "Queue cleared"; }
uninstall() { read -p "Remove Loguard completely? [y/N]: " a; [[ "$a" =~ ^[Yy]$ ]] && rm -rf "$INSTALL_DIR" "$CONFIG_DIR" "/var/log/loguard" && success "Removed"; }

show_help() {
    cat << EOF
Loguard v$VERSION - Login Alerts to Telegram

Commands: status | enable | disable | test | logs [n] | queue | clear-queue | edit | restart | uninstall | help
Use: sudo loguard <command>
EOF
}

main() {
    [[ -f "$INSTALL_DIR/loguard" ]] || { error "Loguard not installed properly."; exit 1; }
    mkdir -p "$CONFIG_DIR" "/var/log/loguard"

    case "${1:-}" in
        status|"")      show_status ;;
        enable)         check_root; enable_alerts ;;
        disable)        check_root; disable_alerts ;;
        test)           check_root; telegram_test ;;
        logs)           show_logs "${2:-}" ;;
        queue)          show_queue ;;
        clear-queue)    check_root; clear_queue ;;
        edit)           check_root; edit_config_wizard ;;
        restart)        check_root; disable_alerts; enable_alerts ;;
        uninstall)      check_root; uninstall ;;
        help|-h)        show_help ;;
        *)              error "Unknown command: $1"; show_help; exit 1 ;;
    esac
}

main "$@"